{%- for module in system.modules -%}
{% for interface in module.interfaces %}
#include "{{module.name|identifier}}/implementation/{{interface.name|lower}}.h"
#include "{{module.name|identifier}}/generated/olink/{{interface.name|lower}}service.adapter.h"
{% endfor %}
{% endfor %}

#include "olink/consolelogger.h"
#include "olink/remoteregistry.h"
#include "apigear/olink/olinkhost.h"

#include <iostream>

using namespace {{ system.name | capital }};

int main(){
    ApiGear::ObjectLink::RemoteRegistry registry;
    ApiGear::ObjectLink::ConsoleLogger logger;
    registry.onLog(logger.logFunc());
    
    ApiGear::PocoImpl::OLinkHost testserver(registry);

    {% for module in system.modules %}
    {% for interface in module.interfaces %}
    {% assign class = interface.name | capital %}
    auto test{{module.name | capital}}{{class}} = std::make_shared<{{ module.name | capital }}::{{class}}>();
    auto test{{module.name|capital}}{{interface.name|capital}}ServiceAdapter = std::make_shared<{{ module.name | capital }}::olink::{{interface.name}}ServiceAdapter>(test{{module.name|capital}}{{interface.name|capital}}, registry);
    registry.addSource(test{{module.name|capital}}{{interface.name|capital}}ServiceAdapter);
    {% endfor %}
    {% endfor %}

    testserver.listen(8000);

    bool keepRunning = true;
    std::string cmd;
    do {
        std::cout << "Enter command:" << std::endl;
        getline (std::cin, cmd);

        if(cmd == "quit"){
            testserver.close();
            keepRunning = false;
        }
    } while(keepRunning);

    {% for module in system.modules %}
    {% for interface in module.interfaces %}
    {% assign class = interface.name | capital %}
    registry.removeSource(test{{module.name|capital}}{{interface.name|capital}}ServiceAdapter->olinkObjectName());
    {% endfor %}
    {% endfor %}
    
    return 0;
}
